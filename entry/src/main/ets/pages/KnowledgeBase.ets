import { promptAction, SymbolGlyphModifier } from '@kit.ArkUI';
import common from '@ohos.app.ability.common';
import { UserPreferencesManager } from 'common';
// âš ï¸ è¯·æ ¹æ®ä½ çš„å®é™…è·¯å¾„ä¿®æ”¹ä»¥ä¸‹ Import
import { chemicalKnowledgeList } from '../SpecificFunctions/Knowledge/KnowledgeData';

// --- ç±»å‹å®šä¹‰ ---
// ä¿®æ”¹ï¼šå¢åŠ äº† date å­—æ®µç”¨äºè®°å½•æ—¥æœŸ
interface NoteItem {
  id: number;
  content: string;
  time: string; // HH:mm
  date: string; // YYYY-MM-DD
}

@Component
export struct KnowledgeBase {
  // 1. æ•°æ®æº
  private allKnowledge: string[] = chemicalKnowledgeList;

  // ã€å…³é”®ä¿®æ”¹ã€‘æ·»åŠ  @Watch ç›‘å¬å™¨
  // å½“ PersistentStorage ä¸­çš„ userId åˆå§‹åŒ–å®Œæˆæˆ–å‘ç”Ÿå˜åŒ–æ—¶ï¼Œè§¦å‘ onUserChange
  @StorageLink('userId') @Watch('onUserChange') userId: string = '';

  // 2. çŠ¶æ€å˜é‡
  @State searchText: string = '';
  @State currentRandomIndex: number = 0;

  @State myNotes: NoteItem[] = [];
  @State myFavorites: string[] = [];

  @State searchResults: string[] = [];
  @State isSearchMode: boolean = false;
  @State isShowAllMode: boolean = false;
  @State isRecitingMode: boolean = false;

  // 3. æ§åˆ¶å™¨é…ç½®
  favDialogController: CustomDialogController = new CustomDialogController({
    builder: FavoritesDialog({
      favorites: this.myFavorites,
      onDelete: (item: string): void => this.toggleFavorite(item),
      onStartRecite: (): void => {
        this.startRecitation()
      }
    }),
    alignment: DialogAlignment.Bottom,
    offset: { dx: 0, dy: 0 },
    autoCancel: true,
    customStyle: true,
    backgroundColor: 'transparent'
  })

  dialogController: CustomDialogController = new CustomDialogController({
    builder: AddNoteDialog({
      onConfirm: (content: string): void => {
        this.addNote(content)
      }
    }),
    alignment: DialogAlignment.Bottom,
    offset: { dx: 0, dy: -20 },
    autoCancel: true,
    customStyle: true
  })

  // --- ç”Ÿå‘½å‘¨æœŸä¸åˆå§‹åŒ– ---
  aboutToAppear(): void {
    this.refreshRandomKnowledge();
    // å¦‚æœé¡µé¢åŠ è½½æ—¶ userId å·²ç»å­˜åœ¨ï¼ˆéç©ºï¼‰ï¼Œç«‹å³åŠ è½½æ•°æ®
    if (this.userId) {
      this.initData();
    }
  }

  // ã€å…³é”®é€»è¾‘ã€‘ç›‘å¬ç”¨æˆ·åˆ‡æ¢
  async onUserChange() {
    if (this.userId) {
      console.info(`[KnowledgeBase] ç›‘æµ‹åˆ°ç”¨æˆ·åˆ‡æ¢: ${this.userId}ï¼Œæ­£åœ¨åˆ·æ–°æ•°æ®...`);
      await this.initData();
    } else {
      // å¦‚æœ userId å˜ä¸ºç©ºï¼ˆä¾‹å¦‚é€€å‡ºç™»å½•ï¼‰ï¼Œæ¸…ç©ºå½“å‰å±•ç¤ºçš„æ•°æ®
      this.myNotes = [];
      this.myFavorites = [];
      promptAction.showToast({ message: 'å·²é€€å‡ºç™»å½•' });
    }
  }

  // åˆå§‹åŒ–æ•°æ®ï¼šæ ¹æ® userId åŠ è½½å¯¹åº”çš„ Preferences
  async initData() {
    if (!this.userId) return;
    const context = getContext(this) as common.UIAbilityContext;

    // 1. åˆå§‹åŒ–è¯¥ç”¨æˆ·çš„ä¸“å±ä»“åº“ (store_{userId})
    await UserPreferencesManager.getInstance().initUser(context, this.userId);

    // 2. è¯»å–æ•°æ®
    // æ³¨æ„ï¼šè™½ç„¶ Key å« 'my_notes_store'ï¼Œä½†å› ä¸ºæ–‡ä»¶ä¸åŒï¼Œå®ç°äº†ç”¨æˆ·éš”ç¦»
    this.myNotes = await UserPreferencesManager.getInstance().getValue<NoteItem[]>('my_notes_store', []);
    this.myFavorites = await UserPreferencesManager.getInstance().getValue<string[]>('my_fav_store', []);
  }

  // --- æŒä¹…åŒ–å­˜å‚¨ ---
  async saveNotesToDisk() {
    if (!this.userId) return;
    await UserPreferencesManager.getInstance().setValue('my_notes_store', this.myNotes);
  }

  async saveFavToDisk() {
    if (!this.userId) return;
    await UserPreferencesManager.getInstance().setValue('my_fav_store', this.myFavorites);
  }

  // --- ä¸šåŠ¡é€»è¾‘ ---
  toggleFavorite(content: string) {
    if (!this.userId) {
      promptAction.showToast({ message: 'è¯·å…ˆç™»å½•åæ”¶è—' });
      return;
    }
    const index = this.myFavorites.indexOf(content);
    if (index !== -1) {
      this.myFavorites.splice(index, 1);
      promptAction.showToast({ message: 'å·²å–æ¶ˆæ”¶è—' });
    } else {
      this.myFavorites.push(content);
      promptAction.showToast({ message: 'å·²æ”¶è—' });
    }
    this.saveFavToDisk();
  }

  isFavorited(content: string): boolean {
    return this.myFavorites.includes(content);
  }

  refreshRandomKnowledge(): void {
    if (this.allKnowledge.length === 0) return;
    let newIndex = Math.floor(Math.random() * this.allKnowledge.length);
    while (newIndex === this.currentRandomIndex && this.allKnowledge.length > 1) {
      newIndex = Math.floor(Math.random() * this.allKnowledge.length);
    }
    this.currentRandomIndex = newIndex;
  }

  addNote(content: string): void {
    if (!content.trim()) return;
    if (!this.userId) {
      promptAction.showToast({ message: 'è¯·å…ˆç™»å½•ä»¥ä¿å­˜ç¬”è®°' });
      return;
    }

    const now = new Date();
    // æ ¼å¼åŒ–æ—¶é—´ HH:mm
    const timeStr = `${now.getHours().toString().padStart(2, '0')}:${now.getMinutes().toString().padStart(2, '0')}`;
    // æ ¼å¼åŒ–æ—¥æœŸ YYYY-MM-DD
    const dateStr = `${now.getFullYear()}-${(now.getMonth() + 1).toString().padStart(2, '0')}-${now.getDate().toString().padStart(2, '0')}`;

    const newNote: NoteItem = {
      id: Date.now(),
      content: content,
      time: timeStr,
      date: dateStr // ä¿å­˜æ—¥æœŸ
    };

    this.myNotes.unshift(newNote);
    this.saveNotesToDisk();
    promptAction.showToast({ message: 'ç¬”è®°å·²ä¿å­˜' });
  }

  deleteNote(index: number) {
    this.myNotes.splice(index, 1);
    this.saveNotesToDisk();
    promptAction.showToast({ message: 'å·²åˆ é™¤' });
  }

  handleSearch(value: string) {
    this.searchText = value;
    if (!value.trim()) {
      this.isSearchMode = false;
      this.searchResults = [];
      return;
    }
    this.isSearchMode = true;
    this.searchResults = this.allKnowledge.filter(item => item.includes(value));
  }

  startRecitation() {
    if (this.myFavorites.length === 0) {
      promptAction.showToast({ message: 'æ”¶è—å¤¹ä¸ºç©ºï¼Œæ— æ³•èƒŒè¯µ' });
      return;
    }
    animateTo({ duration: 400, curve: Curve.FastOutSlowIn }, () => {
      this.isRecitingMode = true;
    })
  }

  // --- UI æ„å»º ---
  build() {
    Stack({ alignContent: Alignment.BottomEnd }) {

      // å±‚çº§1: ä¸»ç•Œé¢å†…å®¹
      Column() {
        this.HeaderTitle()
        this.HeaderSearch()

        List({ space: 16 }) {
          if (this.isSearchMode) {
            // --- æœç´¢æ¨¡å¼ ---
            ListItem() { Text(`æœç´¢ç»“æœ: å…± ${this.searchResults.length} æ¡`).fontSize(14).fontColor(Color.Gray).margin({left:4}) }
            ForEach(this.searchResults, (text: string, index: number) => {
              ListItem() { this.SearchResultItem(text, index) }
            })

          } else if (this.isShowAllMode) {
            // --- æŸ¥çœ‹æ‰€æœ‰çŸ¥è¯†ç‚¹æ¨¡å¼ ---
            ListItem() { Text(`çŸ¥è¯†åº“å…¨é›†: å…± ${this.allKnowledge.length} æ¡`).fontSize(14).fontColor(Color.Gray).margin({left:4}) }
            ForEach(this.allKnowledge, (text: string, index: number) => {
              ListItem() { this.SearchResultItem(text, index) }
            })

          } else {
            // --- é»˜è®¤ Dashboard æ¨¡å¼ ---
            ListItem() { this.RandomCard() }
            ListItem() { this.FavoriteEntryCard() }

            // ç¬”è®°æ ‡é¢˜
            ListItem() {
              Row() {
                Text("æˆ‘çš„é€Ÿè®°").fontSize(18).fontWeight(FontWeight.Bold)
                Blank()
                Text(`å…± ${this.myNotes.length} æ¡`).fontSize(12).fontColor(Color.Gray)
              }
              .width('100%').padding({ left: 4 })
            }

            // ç¬”è®°åˆ—è¡¨
            if (this.myNotes.length === 0) {
              ListItem() {
                Column() {
                  Text("æš‚æ— ç¬”è®°").fontSize(14).fontColor('#CCC').margin({top: 20})
                }.width('100%').alignItems(HorizontalAlign.Center)
              }
            } else {
              ForEach(this.myNotes, (item: NoteItem, index: number) => {
                ListItem() { this.NoteItemView(item) }
                .swipeAction({ end: this.DeleteButton(index) })
              }, (item: NoteItem) => item.id.toString())
            }
          }
          ListItem().height(80)
        }
        .width('100%').layoutWeight(1).padding({ left: 16, right: 16 }).scrollBar(BarState.Off)
      }
      .width('100%').height('100%')
      .backgroundColor('#F1F3F5')
      .visibility(this.isRecitingMode ? Visibility.Hidden : Visibility.Visible)

      // å±‚çº§2: æ‚¬æµ®æ·»åŠ æŒ‰é’®
      if (!this.isSearchMode && !this.isRecitingMode && !this.isShowAllMode) {
        Button({ type: ButtonType.Circle }) {
          SymbolGlyph($r('sys.symbol.plus')).fontSize(30).fontColor([Color.White]).fontWeight(FontWeight.Bold)
        }
        .width(56).height(56).backgroundColor('#007DFF')
        .shadow({ radius: 10, color: 'rgba(0,125,255,0.4)', offsetY: 4 })
        .margin({ right: 24, bottom: 30 })
        .onClick(() => { this.dialogController.open() })
      }

      // å±‚çº§3: æ²‰æµ¸å¼èƒŒè¯µå…¨å±è§†å›¾
      if (this.isRecitingMode) {
        ImmersiveRecitationView({
          list: $myFavorites,
          onExit: () => {
            animateTo({ duration: 300 }, () => {
              this.isRecitingMode = false;
            })
          },
          onRemoveItem: (item: string) => {
            this.toggleFavorite(item);
          }
        })
          .transition(TransitionEffect.OPACITY.animation({ duration: 300 }))
          .zIndex(999)
      }
    }
    .width('100%').height('100%')
  }

  // --- å­ç»„ä»¶ Builder ---
  @Builder HeaderTitle() {
    Row() {
      if (this.isShowAllMode) {
        Button({ type: ButtonType.Circle }) {
          SymbolGlyph($r('sys.symbol.chevron_left'))
            .fontSize(24).fontColor(['#333']).fontWeight(FontWeight.Bold)
        }
        .backgroundColor('transparent').width(40).height(40).margin({ right: 8, left: -10 })
        .onClick(() => {
          animateTo({ duration: 300 }, () => { this.isShowAllMode = false })
        })
      }

      Text(this.isShowAllMode ? "æ‰€æœ‰çŸ¥è¯†ç‚¹" : "å±é™©åŒ–å­¦å“çŸ¥è¯†åº“")
        .fontSize(24).fontWeight(FontWeight.Bold).fontColor('#333')
    }
    .width('100%')
    .padding({ left: 20, right: 20, top: 12, bottom: 4 })
    .backgroundColor('#F1F3F5')
    .margin({top: 30})
    .alignItems(VerticalAlign.Center)
  }

  @Builder HeaderSearch() {
    Row() {
      Search({ value: this.searchText, placeholder: 'æœï¼šè¿è¾“ã€å‚¨å­˜ã€è…èš€...' })
        .width('100%').height(40).backgroundColor(Color.White).placeholderColor('#999')
        .onChange((value) => { this.handleSearch(value) })
    }
    .padding({ top: 8, bottom: 12, left: 16, right: 16 }).backgroundColor('#F1F3F5')
  }

  @Builder
  RandomCard() {
    Column() {
      Row() {
        Text("ğŸ’¡ æ¯æ—¥ä¸€å­¦").fontColor('#FF9800').fontWeight(FontWeight.Bold).fontSize(14)
        Blank()
        Row() {
          Text("æ›´å¤š").fontSize(13).fontColor('#666')
          SymbolGlyph($r('sys.symbol.chevron_right')).fontSize(14).fontColor(['#666'])
        }
        .onClick(() => {
          animateTo({ duration: 300 }, () => { this.isShowAllMode = true })
        })
      }
      .width('100%').margin({ bottom: 12 })

      if (this.allKnowledge.length > 0) {
        Text(this.allKnowledge[this.currentRandomIndex]).fontSize(16).fontColor('#333').lineHeight(26).margin({ bottom: 16 })
      }

      Row() {
        Row() {
          Text("æ¢ä¸€æ¡ ").fontSize(12).fontColor('#007DFF')
          SymbolGlyph($r('sys.symbol.arrow_clockwise')).fontSize(14).fontColor(['#007DFF'])
        }
        .backgroundColor('rgba(0,125,255,0.08)')
        .padding({left: 10, right: 10, top: 6, bottom: 6})
        .borderRadius(14)
        .onClick(() => { animateTo({ duration: 300 }, () => { this.refreshRandomKnowledge() }) })

        Blank()

        if (this.allKnowledge.length > 0) {
          SymbolGlyph(this.isFavorited(this.allKnowledge[this.currentRandomIndex]) ? $r('sys.symbol.star_fill') : $r('sys.symbol.star'))
            .fontSize(22)
            .fontColor(this.isFavorited(this.allKnowledge[this.currentRandomIndex]) ? ['#FFB900'] : ['#CCC'])
            .onClick(() => { this.toggleFavorite(this.allKnowledge[this.currentRandomIndex]) })
        }
      }
      .width('100%')
    }
    .width('100%').padding(20).backgroundColor(Color.White).borderRadius(16).shadow({ radius: 12, color: 'rgba(0,0,0,0.06)', offsetY: 4 })
  }

  @Builder
  FavoriteEntryCard() {
    Row() {
      Row() {
        SymbolGlyph($r('sys.symbol.star_fill')).fontSize(18).fontColor(['#FFB900']).margin({ right: 8 })
        Text("æˆ‘çš„çŸ¥è¯†æ”¶è—å¤¹").fontSize(16).fontWeight(FontWeight.Medium)
      }
      Blank()
      Row() {
        Text(`${this.myFavorites.length} æ¡å†…å®¹`).fontSize(13).fontColor('#999').margin({ right: 4 })
        SymbolGlyph($r('sys.symbol.chevron_right')).fontSize(14).fontColor(['#CCC'])
      }
    }
    .width('100%').padding(16).backgroundColor(Color.White).borderRadius(12).onClick(() => { this.favDialogController.open() })
  }

  @Builder SearchResultItem(text: string, index: number) {
    Column() {
      Row() {
        Text(`${index + 1}`)
          .fontSize(12).fontColor(Color.White).backgroundColor('#007DFF')
          .constraintSize({ minWidth: 20 }).padding({ left: 6, right: 6 }).height(20)
          .textAlign(TextAlign.Center).borderRadius(10).margin({ right: 10, top: 2 })

        Text(text).fontSize(15).fontColor('#333').lineHeight(24).layoutWeight(1)
        SymbolGlyph(this.isFavorited(text) ? $r('sys.symbol.star_fill') : $r('sys.symbol.star'))
          .fontSize(20).fontColor(this.isFavorited(text) ? ['#FFB900'] : ['#DDD']).margin({ left: 8 })
          .onClick(() => { this.toggleFavorite(text) })
      }
      .alignItems(VerticalAlign.Top)
    }
    .width('100%').padding(16).backgroundColor(Color.White).borderRadius(12).margin({ bottom: 4 })
  }

  @Builder NoteItemView(item: NoteItem) {
    Column() {
      Text(item.content).fontSize(15).fontColor('#333').lineHeight(22).margin({ bottom: 8 })
      Row() {
        // ä¿®æ­£ï¼šæ˜¾ç¤ºæ—¥æœŸå’Œæ—¶é—´
        Text(item.date).fontSize(12).fontColor('#999').margin({ right: 8 })
        Text(item.time).fontSize(12).fontColor('#999')
      }
    }
    .width('100%').padding(16).backgroundColor(Color.White).borderRadius(12)
    .alignItems(HorizontalAlign.Start)
  }

  @Builder DeleteButton(index: number) {
    Button() { SymbolGlyph($r('sys.symbol.trash')).fontSize(24).fontColor([Color.White]) }
    .type(ButtonType.Normal).width(60).height('100%').backgroundColor('#FF3B30').borderRadius({ topLeft: 0, bottomLeft: 0, topRight: 12, bottomRight: 12 }).margin({ left: 10 })
    .onClick(() => { this.deleteNote(index) })
  }
}

// ----------------------------------------------------
// ç»„ä»¶ï¼šImmersiveRecitationView (æ²‰æµ¸å¼èƒŒè¯µ)
// ----------------------------------------------------
@Component
struct ImmersiveRecitationView {
  @Link list: string[];
  onExit: () => void = () => {};
  onRemoveItem: (item: string) => void = () => {};

  @State currentIndex: number = 0;

  handleRemoveCurrent() {
    if (this.list.length === 0) return;
    const itemToRemove = this.list[this.currentIndex];
    this.onRemoveItem(itemToRemove);
    if (this.list.length === 0) {
      this.onExit();
      promptAction.showToast({ message: 'æ”¶è—å¤¹å·²æ¸…ç©º' });
    } else {
      if (this.currentIndex >= this.list.length) {
        this.currentIndex = this.list.length - 1;
      }
      promptAction.showToast({ message: 'å·²å–æ¶ˆæ”¶è—' });
    }
  }

  build() {
    Column() {
      // 1. é¡¶éƒ¨
      Row() {
        if (this.list.length > 0) {
          Row() {
            Text(`${this.currentIndex + 1} / ${this.list.length}`).fontColor(Color.White).fontSize(14).fontWeight(FontWeight.Medium)
          }
          .backgroundColor('rgba(255,255,255,0.2)').padding({ left: 12, right: 12, top: 6, bottom: 6 }).borderRadius(16)
        }
        Blank()
        Button() { Text("é€€å‡º").fontColor('rgba(255,255,255,0.8)').fontSize(15) }
        .type(ButtonType.Normal).backgroundColor(Color.Transparent).onClick(() => { this.onExit() })
      }
      .width('100%').padding({ left: 24, right: 24, top: 60, bottom: 20 })

      // 2. ä¸­é—´å¡ç‰‡
      Column() {
        if (this.list.length > 0) {
          Stack({ alignContent: Alignment.TopEnd }) {
            Column() {
              SymbolGlyph($r('sys.symbol.bookmark')).fontSize(30).fontColor(['rgba(255,255,255,0.6)']).margin({bottom: 24})
              Text(this.list[this.currentIndex]).fontSize(22).fontWeight(FontWeight.Medium).fontColor(Color.White).textAlign(TextAlign.Center).lineHeight(34).opacity(0.95)
            }
            .width('100%').padding({ top: 40, bottom: 40, left: 30, right: 30 })

            Button({ type: ButtonType.Circle }) { SymbolGlyph($r('sys.symbol.star_fill')).fontSize(24).fontColor(['#FFB900']) }
            .width(44).height(44).backgroundColor('rgba(255,255,255,0.15)').margin({ top: 10, right: 10 })
            .onClick(() => { this.handleRemoveCurrent() })
          }
          .width('100%').backgroundColor('rgba(255,255,255, 0.1)').backdropBlur(20).borderRadius(32)
          .border({ width: 1, color: 'rgba(255,255,255,0.1)' }).shadow({ radius: 20, color: 'rgba(0,0,0,0.2)', offsetY: 10 })
          .onClick(() => {
            if (this.currentIndex < this.list.length - 1) {
              animateTo({ duration: 300, curve: Curve.EaseInOut }, () => { this.currentIndex++ })
            } else {
              animateTo({ duration: 300, curve: Curve.EaseInOut }, () => { this.currentIndex = 0 })
              promptAction.showToast({ message: 'å·²ä»å¤´å¼€å§‹', bottom: 100 })
            }
          })
        } else {
          Text("å·²å…¨éƒ¨èƒŒè¯µå®Œæˆï¼").fontSize(20).fontColor(Color.White)
        }
      }
      .layoutWeight(1).width('86%').justifyContent(FlexAlign.Center).margin({bottom: 40})

      // 3. åº•éƒ¨
      Row() {
        Button() { SymbolGlyph($r('sys.symbol.chevron_left')).fontSize(28).fontColor(['rgba(255,255,255,0.9)']) }
        .type(ButtonType.Circle).backgroundColor('rgba(0,0,0,0.2)').width(60).height(60)
        .enabled(this.list.length > 0)
        .onClick(() => {
          if (this.currentIndex > 0) {
            animateTo({ duration: 300 }, () => { this.currentIndex-- })
          } else {
            promptAction.showToast({ message: 'è¿™æ˜¯ç¬¬ä¸€æ¡', bottom: 100 })
          }
        })

        Column() {
          Text("ç‚¹å‡»å¡ç‰‡åˆ‡æ¢").fontSize(12).fontColor('rgba(255,255,255,0.4)')
          Text("ç‚¹å‡»æ˜Ÿå·ç§»é™¤").fontSize(12).fontColor('rgba(255,255,255,0.4)').margin({top: 4})
        }
        .margin({ left: 30, right: 30 })

        Button() { SymbolGlyph($r('sys.symbol.chevron_right')).fontSize(28).fontColor(['rgba(255,255,255,0.9)']) }
        .type(ButtonType.Circle).backgroundColor('rgba(0,0,0,0.2)').width(60).height(60)
        .enabled(this.list.length > 0)
        .onClick(() => {
          if (this.currentIndex < this.list.length - 1) {
            animateTo({ duration: 300 }, () => { this.currentIndex++ })
          } else {
            promptAction.showToast({ message: 'å­¦ä¹ å®Œæˆï¼', bottom: 100 })
          }
        })
      }
      .margin({ bottom: 60 })
    }
    .width('100%').height('100%')
    .linearGradient({ direction: GradientDirection.RightBottom, colors: [['#2E1437', 0.0], ['#2C3E50', 0.6], ['#4CA1AF', 1.0]] })
  }
}

// ----------------------------------------------------
// ç»„ä»¶ï¼šFavoritesDialog (æ”¶è—å¤¹)
// ----------------------------------------------------
@CustomDialog
struct FavoritesDialog {
  controller?: CustomDialogController
  @Link favorites: string[]
  onDelete: (item: string) => void = () => {}
  onStartRecite: () => void = () => {}

  build() {
    Column() {
      Row().width(40).height(5).backgroundColor('#E0E0E0').borderRadius(3).margin({ top: 10, bottom: 20 })
      Row() {
        Column() {
          Text("æˆ‘çš„çŸ¥è¯†æ”¶è—").fontSize(22).fontWeight(FontWeight.Bold).fontColor('#333')
          Text(`å…± ${this.favorites.length} æ¡é‡ç‚¹çŸ¥è¯†`).fontSize(13).fontColor('#999').margin({top: 4})
        }.alignItems(HorizontalAlign.Start)
        Blank()
        Button({ type: ButtonType.Circle }) { SymbolGlyph($r('sys.symbol.xmark')).fontSize(16).fontColor(['#999']) }
        .width(30).height(30).backgroundColor('#F5F5F5').onClick(() => { this.controller?.close() })
      }
      .width('100%').padding({ left: 24, right: 24, bottom: 20 })

      if (this.favorites.length > 0) {
        Button() {
          Row() {
            SymbolGlyph($r('sys.symbol.play_circle_fill')).fontSize(20).fontColor([Color.White]).margin({right: 8})
            Text("å¼€å§‹æ²‰æµ¸èƒŒè¯µ").fontSize(16).fontColor(Color.White).fontWeight(FontWeight.Bold)
          }
        }
        .width('90%').height(50).linearGradient({ direction: GradientDirection.Right, colors: [['#007DFF', 0.0], ['#00B4FF', 1.0]] })
        .shadow({ radius: 10, color: 'rgba(0,125,255,0.3)', offsetY: 5 }).margin({ bottom: 20 })
        .onClick(() => { this.controller?.close(); this.onStartRecite(); })
      }

      if (this.favorites.length === 0) {
        Column() {
          Text("ğŸ“‚").fontSize(50).margin({bottom: 10})
          Text("è¿˜æ²¡æœ‰æ”¶è—ä»»ä½•å†…å®¹").fontSize(15).fontColor('#999')
          Text("å»æ¯æ—¥ä¸€å­¦æˆ–è€…æœç´¢é‡Œæ‰¾æ‰¾å§").fontSize(12).fontColor('#CCC').margin({top: 5})
        }
        .height(200).justifyContent(FlexAlign.Center)
      } else {
        List({ space: 12 }) {
          ForEach(this.favorites, (item: string, index: number) => {
            ListItem() {
              Row() {
                Text(`${index + 1}`.padStart(2, '0')).fontSize(14).fontColor('#DDD').fontWeight(FontWeight.Bold).margin({ right: 12 })
                Text(item).fontSize(15).fontColor('#333')
                  .maxLines(2)
                  .textOverflow({ overflow: TextOverflow.Ellipsis })
                  .layoutWeight(1)
                  .lineHeight(22)

                Button({ type: ButtonType.Circle }) {
                  Text("Ã—").fontSize(18).fontColor('#999')
                }
                .backgroundColor('transparent')
                .width(30).height(30)
                .onClick(() => {
                  this.onDelete(item)
                })
              }
              .width('100%')
              .padding(16)
              .backgroundColor(Color.White)
              .borderRadius(16)
              .shadow({ radius: 8, color: 'rgba(0,0,0,0.03)', offsetY: 2 })
            }
          })
        }
        .width('100%')
        .height(350)
        .padding({ left: 16, right: 16 })
        .scrollBar(BarState.Auto)
      }
    }
    .backgroundColor('#F9F9F9')
    .borderRadius({ topLeft: 24, topRight: 24 })
    .width('100%')
    .padding({ bottom: 20 })
  }
}

// ----------------------------------------------------
// ç»„ä»¶ï¼šAddNoteDialog (æ·»åŠ ç¬”è®°)
// ----------------------------------------------------
@CustomDialog
struct AddNoteDialog {
  controller?: CustomDialogController
  onConfirm: (content: string) => void = (content: string): void => {}
  @State noteContent: string = ''

  build() {
    Column() {
      Text("æ·»åŠ å®‰å…¨ç¬”è®°")
        .fontSize(18)
        .fontWeight(FontWeight.Bold)
        .margin({ top: 20, bottom: 16 })
        .fontColor('#333')

      TextArea({ placeholder: 'è®°å½•éšæ‚£æˆ–çŸ¥è¯†ç‚¹...', text: this.noteContent })
        .height(120)
        .backgroundColor('#F5F5F5')
        .borderRadius(12)
        .fontSize(15)
        .onChange((value) => { this.noteContent = value })
        .margin({ bottom: 20 })

      Row() {
        Button("å–æ¶ˆ")
          .backgroundColor('#F2F2F2')
          .fontColor('#666')
          .fontSize(15)
          .fontWeight(FontWeight.Medium)
          .layoutWeight(1)
          .height(40)
          .margin({ right: 12 })
          .onClick(() => {
            if (this.controller) { this.controller.close() }
          })

        Button("ä¿å­˜")
          .backgroundColor('#007DFF')
          .fontColor(Color.White)
          .fontSize(15)
          .fontWeight(FontWeight.Medium)
          .layoutWeight(1)
          .height(40)
          .onClick(() => {
            this.onConfirm(this.noteContent);
            if (this.controller) { this.controller.close() }
          })
      }
      .width('100%')
    }
    .padding(24)
    .backgroundColor(Color.White)
    .borderRadius(24)
    .width('90%')
    .shadow({ radius: 20, color: 'rgba(0,0,0,0.1)', offsetY: 10 })
  }
}
